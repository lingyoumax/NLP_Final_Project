# QA fintuen using Qwen-7B-Chat[^1]
## 1. Dataset optimization
### I. Generation of more data sets：
Use the self instuct[^2] method to generate the data set using the QA seed library we concocted.But in contrast to the generation for generic domains used in the original approach, we set the INSTRUCTION to the relevant statement segment, the INPUT to the different types of questions, and the OUTPUT to the corresponding answers. Similarly it is also categorized into judgmental and non-judgmental questions.
### II.MoDS filter dataset
Using the MoDS[^3] method to filter out higher quality datasets.

## 2.Model training
### I. supervised fine-tuning(SFT folder)
- a.We used the enhanced dataset obtained earlier to accomplish this step of fine-tuning.
- b.Quantization at model load due to resource issues
- c.Compared to full fine-tuning, we use the adapter[^4] approach which is less memory intensive and more efficient.
### II.Reward model fine-tuning(Reward folder)
- a.Our reward model is based on the Qwen_SFT trained in the previous step to select the last layer of lm_head, and uses a new v_head layer (full linear) as the reward model.
- b.In the construction of the data set, we used self instruct to construct a large number of questions, and then used Qwen_SFT to generate different answers based on random parameters such as temperature and top_p. Then use GPT3.5 as the reply scoring machine. So we have a training data set.
- c.In addition, we use 8000 of full-hh-rlhf[^5] as an additional training data set.
- d.For some other parameters, see the corresponding global_config.py.
### III. Pipeline (Pipeline folder)
- a.RejectSampling[^7]
  - Here we use two training methods. First, we perform multiple inferences on the SFT model to obtain several responses, which are sent to the rm model for scoring. The response with the highest score for each question is selected as the answer to the question, and then fine-tuned again.
- b.DPO[^8]
  - Here, a pair is composed of the response generated by the previous version and the response generated by the latest SFT fine-tuning version, and then the DPO method is used for fine-tuning.The DPO training here mainly uses the trl library[^6].

## 2.Environment Configuration
- a.SFT and Reward model Training configuration
  - random access memory (RAM):Minimum 15GB
  - Display card：4090,24GB(for training, at least 15GB)
- b.SFT and Reward model Inference Configuration
  -  random access memory (RAM):Minimum 5GB
  -  Display card：4090,24GB(for inference, at least 12GB, if for batch inference, Recommended minimum 18GB)
- c. reject sample and DPO:
  - random access memory (RAM):Minimum 15GB
  - Display card：A100,40GB
## 4.How to use
- a. build dataset
  - can see dataset_optimization
- b.supervised fine-tuning:
  - find the SFT-fintune
  - if want to train a new lora model, set global_configs.lora_model="", and use "python train.py"
  - if want to continue train the lora model, down load the lora model from link in [SFT_lora_out](https://drive.google.com/drive/folders/1L6feQcrPOoORwVS9j0UsujLYZbetOr6G?usp=drive_link), set global_configs.lora_model="Qwen_sft_out", and use "python train.py"
- c.reward model
  - Fine-tune reward model
  - if want to train a new lora model, set global_configs.lora_model="", and use "python train.py"
  - if want to continue train the lora model, down load the lora model from link in [Reward_finetune_lora_out](https://drive.google.com/drive/folders/1jpcBMJ_tisyFxn2j8qMjY3M4Nm98gUBu?usp=sharing), set global_configs.lora_model="Qwen_sft_out", and use "python train.py"
- d.Pipeline
  - The main purpose here is to run reject_sampling.py and DPO.py, and the corresponding configuration parameters need to be changed so that they can run normally.
  - Reject_sampling can mainly complete 4 steps: self instruct generates questions, fine-tuning the model to generate different responses, reward model generating scores, and selecting the highest score with SFT
  - reject_sampling can mainly complete 4 steps, self instruct generates questions, fine-tuning the model generates different responses, reward model generates the highest and lowest scores, and DPO fine-tuning
## 6.Deployment of models
- **see other part**
## **Citation**:
[^1]:```bibtex
    @article{qwen,
    title={Qwen Technical Report},
    author={Jinze Bai and Shuai Bai and Yunfei Chu and Zeyu Cui and Kai Dang and Xiaodong Deng and Yang Fan and Wenbin Ge and Yu Han and Fei Huang and Binyuan Hui and Luo Ji and Mei Li and Junyang Lin and Runji Lin and Dayiheng Liu and Gao Liu and Chengqiang Lu and Keming Lu and Jianxin Ma and Rui Men and Xingzhang Ren and Xuancheng Ren and Chuanqi Tan and Sinan Tan and Jianhong Tu and Peng Wang and Shijie Wang and Wei Wang and Shengguang Wu and Benfeng Xu and Jin Xu and An Yang and Hao Yang and Jian Yang and Shusheng Yang and Yang Yao and Bowen Yu and Hongyi Yuan and Zheng Yuan and Jianwei Zhang and Xingxuan Zhang and Yichang Zhang and Zhenru Zhang and Chang Zhou and Jingren Zhou and Xiaohuan Zhou and Tianhang Zhu},
    journal={arXiv preprint arXiv:2309.16609},
    year={2023}
    }
    ```
[^2]:```bibtex
      @misc{selfinstruct,
      title={Self-Instruct: Aligning Language Model with Self Generated Instructions},
      author={Wang, Yizhong and Kordi, Yeganeh and Mishra, Swaroop and Liu, Alisa and Smith, Noah A. and Khashabi, Daniel and Hajishirzi, Hannaneh},
      journal={arXiv preprint arXiv:2212.10560},
      year={2022}
      }
      ```
[^3]:```bibtex
      @misc{du2023mods,
      title={MoDS: Model-oriented Data Selection for Instruction Tuning}, 
      author={Qianlong Du and Chengqing Zong and Jiajun Zhang},
      year={2023},
      eprint={2311.15653},
      archivePrefix={arXiv},
      primaryClass={cs.CL}
    }
    ```
[^4]:```bibtex
      @Misc{peft,
      title =        {PEFT: State-of-the-art Parameter-Efficient Fine-Tuning methods},
      author =       {Sourab Mangrulkar and Sylvain Gugger and Lysandre Debut and Younes Belkada and Sayak Paul and Benjamin Bossan},
      howpublished = {\url{https://github.com/huggingface/peft}},
      year =         {2022}
      }
     ```
[^5]:(https://huggingface.co/datasets/Dahoas/full-hh-rlhf)
[^6]:```bibtex
      @misc{vonwerra2022trl,
      author = {Leandro von Werra and Younes Belkada and Lewis Tunstall and Edward Beeching and Tristan Thrush and Nathan Lambert and Shengyi Huang},
      title = {TRL: Transformer Reinforcement Learning},
      year = {2020},
      publisher = {GitHub},
      journal = {GitHub repository},
      howpublished = {\url{https://github.com/huggingface/trl}}
      }
     ```
[^7]:https://ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/
[^8]:```bibtex
      @article{rafailov2024direct,
      title={Direct preference optimization: Your language model is secretly a reward model},
      author={Rafailov, Rafael and Sharma, Archit and Mitchell, Eric and Manning, Christopher D and Ermon, Stefano and Finn, Chelsea},
      journal={Advances in Neural Information Processing Systems},
      volume={36},
      year={2024}
      }
     ```
